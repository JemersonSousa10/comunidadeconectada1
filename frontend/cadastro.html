<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro - Comunidade Conectada</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/accessibility.css">
</head>
<body>
    <header role="banner">
        <nav class="navbar" role="navigation" aria-label="Navega√ß√£o principal">
            <div class="nav-container">
                <h1 class="logo">
                    <a href="index.html" aria-label="Comunidade Conectada">
                        üåê Comunidade Conectada
                    </a>
                </h1>
                <ul class="nav-menu">
                    <li><a href="index.html">In√≠cio</a></li>
                    <li><a href="servicos.html">Servi√ßos</a></li>
                    <li><a href="login.html">Login</a></li>
                    <li><a href="cadastro.html" aria-current="page">Cadastrar</a></li>
                </ul>
            </div>
        </nav>
    </header>

    <main role="main">
        <section class="auth-section" aria-labelledby="cadastro-title">
            <div class="auth-container">
                <div class="auth-card">
                    <h1 id="cadastro-title">Criar sua conta</h1>
                    <p class="auth-subtitle">Junte-se √† nossa comunidade</p>

                    <form id="cadastroForm" class="auth-form">
                        <div class="form-group">
                            <label for="nome">Nome completo *</label>
                            <input 
                                type="text" 
                                id="nome" 
                                name="nome" 
                                required 
                                aria-required="true"
                            >
                        </div>

                        <div class="form-group">
                            <label for="email">E-mail *</label>
                            <input 
                                type="email" 
                                id="email" 
                                name="email" 
                                required 
                                aria-required="true"
                            >
                        </div>

                        <div class="form-group">
                            <label for="senha">Senha *</label>
                            <input 
                                type="password" 
                                id="senha" 
                                name="senha" 
                                required 
                                aria-required="true"
                                minlength="6"
                                aria-describedby="senha-help"
                            >
                            <small id="senha-help" class="help-text">M√≠nimo de 6 caracteres, incluindo letras e n√∫meros</small>
                        </div>

                        <div class="form-group">
                            <label for="confirmarSenha">Confirmar senha *</label>
                            <input 
                                type="password" 
                                id="confirmarSenha" 
                                name="confirmarSenha" 
                                required 
                                aria-required="true"
                            >
                        </div>

                        <fieldset class="form-group">
                            <legend>Tipo de conta *</legend>
                            <div class="radio-group">
                                <label class="radio-label">
                                    <input 
                                        type="radio" 
                                        name="tipo" 
                                        value="morador" 
                                        checked
                                        aria-checked="true"
                                    >
                                    <span class="radio-custom"></span>
                                    Morador
                                </label>
                                <label class="radio-label">
                                    <input 
                                        type="radio" 
                                        name="tipo" 
                                        value="prestador"
                                        aria-checked="false"
                                    >
                                    <span class="radio-custom"></span>
                                    Prestador de Servi√ßos
                                </label>
                            </div>
                        </fieldset>

                        <div class="form-group">
                            <label for="telefone">Telefone</label>
                            <input 
                                type="tel" 
                                id="telefone" 
                                name="telefone" 
                                placeholder="(11) 99999-9999"
                            >
                        </div>

                        <div class="form-group">
                            <label for="cep">CEP</label>
                            <div class="input-with-button">
                                <input 
                                    type="text" 
                                    id="cep" 
                                    name="cep" 
                                    placeholder="00000-000"
                                    maxlength="9"
                                >
                                <button type="button" id="buscarCep" class="btn btn-outline">
                                    Buscar
                                </button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="endereco">Endere√ßo</label>
                            <input 
                                type="text" 
                                id="endereco" 
                                name="endereco" 
                                readonly
                            >
                        </div>

                        <div class="form-group">
                            <label for="cidade">Cidade</label>
                            <input 
                                type="text" 
                                id="cidade" 
                                name="cidade" 
                                readonly
                            >
                        </div>

                        <div class="form-group">
                            <label for="estado">Estado</label>
                            <input 
                                type="text" 
                                id="estado" 
                                name="estado" 
                                readonly
                            >
                        </div>

                        <div class="form-group checkbox-group">
                            <label class="checkbox-label">
                                <input 
                                    type="checkbox" 
                                    id="termos" 
                                    name="termos" 
                                    required
                                    aria-required="true"
                                >
                                <span class="checkbox-custom"></span>
                                Concordo com os <a href="#" target="_blank">Termos de Uso</a> e 
                                <a href="#" target="_blank">Pol√≠tica de Privacidade</a> *
                            </label>
                        </div>

                        <button type="submit" class="btn btn-primary btn-full" id="submitBtn">
                            Criar conta
                        </button>

                        <div class="auth-links">
                            <p>
                                J√° tem uma conta? <a href="login.html">Fa√ßa login aqui</a>
                            </p>
                        </div>
                    </form>
                </div>
            </div>
        </section>
    </main>

    <footer role="contentinfo">
        <div class="container">
            <p>&copy; 2025 Comunidade Conectada. Projeto Integrador II - UNIVESP.</p>
        </div>
    </footer>

    <script src="js/utils.js"></script>
<script src="js/api.js"></script>
<script src="js/auth.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('‚úÖ P√°gina de cadastro com CEP carregada');
        
        // Verificar se j√° est√° autenticado
        if (localStorage.getItem('token')) {
            alert('‚ö†Ô∏è Voc√™ j√° est√° logado!');
            window.location.href = 'servicos.html';
            return;
        }
        
        // Configurar eventos
        const cadastroForm = document.getElementById('cadastroForm');
        const buscarCepBtn = document.getElementById('buscarCep');
        
        if (cadastroForm) {
            cadastroForm.addEventListener('submit', handleRegister);
            console.log('‚úÖ Evento de submit configurado');
        }
        
        if (buscarCepBtn) {
            buscarCepBtn.addEventListener('click', function() {
                console.log('üìç Bot√£o Buscar CEP clicado');
                buscarCEP();
            });
            console.log('‚úÖ Evento de CEP configurado');
        }
        
        // Formata√ß√£o autom√°tica do CEP
        const cepInput = document.getElementById('cep');
        if (cepInput) {
            cepInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 5) {
                    value = value.substring(0,5) + '-' + value.substring(5,8);
                }
                e.target.value = value;
            });
            
            // Permitir buscar CEP pressionando Enter
            cepInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    buscarCEP();
                }
            });
        }
        
        // Valida√ß√£o em tempo real da senha
        const senhaInput = document.getElementById('senha');
        if (senhaInput) {
            senhaInput.addEventListener('input', function() {
                validarSenhaEmTempoReal();
            });
        }
        
        // Valida√ß√£o em tempo real da confirma√ß√£o de senha
        const confirmarSenhaInput = document.getElementById('confirmarSenha');
        if (confirmarSenhaInput) {
            confirmarSenhaInput.addEventListener('input', function() {
                validarConfirmacaoSenha();
            });
        }
    });
    
    // Valida√ß√£o em tempo real da senha
    function validarSenhaEmTempoReal() {
        const senha = document.getElementById('senha').value;
        const feedback = document.getElementById('senha-help');
        
        if (!feedback) return;
        
        if (senha.length > 0 && senha.length < 6) {
            feedback.style.color = '#e74c3c';
            feedback.textContent = 'A senha precisa ter pelo menos 6 caracteres';
        } else if (senha.length >= 6 && !(/[a-zA-Z]/.test(senha) && /[0-9]/.test(senha))) {
            feedback.style.color = '#e74c3c';
            feedback.textContent = 'A senha precisa conter letras e n√∫meros';
        } else if (senha.length >= 6 && /[a-zA-Z]/.test(senha) && /[0-9]/.test(senha)) {
            feedback.style.color = '#27ae60';
            feedback.textContent = 'Senha v√°lida!';
        } else {
            feedback.style.color = '#666';
            feedback.textContent = 'M√≠nimo de 6 caracteres, incluindo letras e n√∫meros';
        }
    }
    
    // Valida√ß√£o em tempo real da confirma√ß√£o de senha
    function validarConfirmacaoSenha() {
        const senha = document.getElementById('senha').value;
        const confirmarSenha = document.getElementById('confirmarSenha').value;
        const confirmarSenhaInput = document.getElementById('confirmarSenha');
        
        if (!confirmarSenhaInput) return;
        
        if (confirmarSenha.length > 0 && senha !== confirmarSenha) {
            confirmarSenhaInput.style.borderColor = '#e74c3c';
        } else if (confirmarSenha.length > 0 && senha === confirmarSenha) {
            confirmarSenhaInput.style.borderColor = '#27ae60';
        } else {
            confirmarSenhaInput.style.borderColor = '#ddd';
        }
    }

    // Fun√ß√£o para buscar CEP - VERS√ÉO CORRIGIDA E ROBUSTA
    async function buscarCEP() {
        console.log('üü° Iniciando busca de CEP...');
        
        const cepInput = document.getElementById('cep');
        if (!cepInput) {
            console.error('‚ùå Elemento CEP n√£o encontrado');
            alert('Erro: Campo CEP n√£o encontrado');
            return;
        }
        
        const cep = cepInput.value.replace(/\D/g, '');
        console.log('üü° CEP formatado:', cep);
        
        if (cep.length !== 8) {
            alert('‚ùå Por favor, digite um CEP v√°lido com 8 d√≠gitos.');
            cepInput.focus();
            return;
        }
        
        try {
            console.log('üü° Buscando CEP na API...');
            
            // Mostrar loading no bot√£o
            const buscarBtn = document.getElementById('buscarCep');
            const originalText = buscarBtn.textContent;
            buscarBtn.textContent = 'Buscando...';
            buscarBtn.disabled = true;
            
            const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
            console.log('üü° Resposta da API:', response.status);
            
            if (!response.ok) {
                throw new Error(`Erro HTTP: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('üü° Dados do CEP:', data);
            
            if (data.erro) {
                throw new Error('CEP n√£o encontrado');
            }
            
            // Preencher os campos com os dados do CEP
            document.getElementById('endereco').value = data.logradouro || '';
            document.getElementById('cidade').value = data.localidade || '';
            document.getElementById('estado').value = data.uf || '';
            
            console.log('‚úÖ CEP encontrado e campos preenchidos');
            
        } catch (error) {
            console.error('‚ùå Erro ao buscar CEP:', error);
            
            if (error.message.includes('CEP n√£o encontrado')) {
                alert('‚ùå CEP n√£o encontrado. Verifique o n√∫mero digitado.');
            } else if (error.message.includes('Failed to fetch')) {
                alert('‚ùå Erro de conex√£o. Verifique sua internet e tente novamente.');
            } else {
                alert('‚ùå Erro ao buscar CEP: ' + error.message);
            }
            
            // Limpar campos em caso de erro
            document.getElementById('endereco').value = '';
            document.getElementById('cidade').value = '';
            document.getElementById('estado').value = '';
            
        } finally {
            // Restaurar bot√£o
            const buscarBtn = document.getElementById('buscarCep');
            if (buscarBtn) {
                buscarBtn.textContent = 'Buscar';
                buscarBtn.disabled = false;
            }
        }
    }
</script>